{% extends "base.html" %}

{% block title %}Mapping Config - JournalSmart for QBO{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Account Mapping Configuration</h1>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Configure patterns to automatically map journal entries to the correct accounts.</p>
        </div>
        <div class="flex items-center gap-2">
            <button
                id="openImportExportBtn"
                class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-900 transition-colors"
                title="Import/Export mappings"
            >
                <svg class="mr-1.5 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 7.5h-.75A2.25 2.25 0 004.5 9.75v7.5a2.25 2.25 0 002.25 2.25h7.5a2.25 2.25 0 002.25-2.25v-7.5a2.25 2.25 0 00-2.25-2.25h-.75m0-3l-3-3m0 0l-3 3m3-3v11.25m6-2.25h.75a2.25 2.25 0 012.25 2.25v7.5a2.25 2.25 0 01-2.25 2.25h-7.5a2.25 2.25 0 01-2.25-2.25v-7.5a2.25 2.25 0 012.25-2.25h.75" />
                </svg>
                Import/Export
            </button>
            <button
                id="addMappingBtn"
                class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-900 transition-colors"
            >
                <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Add Mapping
            </button>
        </div>
    </div>

    <!-- Current Mappings Card -->
    <div class="bg-white dark:bg-gray-800 shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <h2 class="text-base font-semibold text-gray-900 dark:text-white flex items-center">
                    <svg class="mr-2 h-5 w-5 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                    </svg>
                    Current Mappings
                    <span id="mappingCount" class="ml-2 inline-flex items-center rounded-full bg-primary-100 dark:bg-primary-900/50 px-2.5 py-0.5 text-xs font-medium text-primary-800 dark:text-primary-300">
                        {{ mappings | length }}
                    </span>
                </h2>
                <!-- Category Filter -->
                <div id="categoryFilter" class="flex flex-wrap items-center gap-2">
                    <span class="text-xs text-gray-500 dark:text-gray-400 mr-1">Filter:</span>
                    <button
                        data-category=""
                        class="category-filter-btn active inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full transition-colors bg-primary-100 dark:bg-primary-900/50 text-primary-700 dark:text-primary-300"
                    >
                        All
                        <span class="ml-1 text-primary-500 dark:text-primary-400" id="count-all">{{ mappings | length }}</span>
                    </button>
                    {% set categories = {} %}
                    {% for mapping in mappings %}
                        {% if mapping.category %}
                            {% if mapping.category not in categories %}
                                {% set _ = categories.update({mapping.category: 0}) %}
                            {% endif %}
                            {% set _ = categories.update({mapping.category: categories[mapping.category] + 1}) %}
                        {% endif %}
                    {% endfor %}
                    {% for cat, count in categories.items() | sort %}
                    <button
                        data-category="{{ cat }}"
                        class="category-filter-btn inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full transition-colors bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 hover:bg-blue-100 hover:text-blue-700 dark:hover:bg-blue-900/50 dark:hover:text-blue-300"
                    >
                        {{ cat }}
                        <span class="ml-1 opacity-60">{{ count }}</span>
                    </button>
                    {% endfor %}
                    {% set uncategorized = mappings | selectattr('category', 'none') | list | length + mappings | selectattr('category', 'equalto', '') | list | length %}
                    {% if uncategorized > 0 %}
                    <button
                        data-category="__uncategorized__"
                        class="category-filter-btn inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full transition-colors bg-gray-100 dark:bg-gray-700 text-gray-500 dark:text-gray-500 hover:bg-gray-200 dark:hover:bg-gray-600"
                    >
                        Uncategorized
                        <span class="ml-1 opacity-60">{{ uncategorized }}</span>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="p-4 sm:p-6">
            <div id="mappingsContainer">
                {% if mappings %}
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead>
                            <tr>
                                <th scope="col" class="w-10 py-3 pl-2 pr-1 text-left text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400">
                                    <span class="sr-only">Drag</span>
                                </th>
                                <th scope="col" class="py-3 pl-2 pr-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400">Status</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400">Pattern</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400">Category</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400">From Account</th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400">To Account</th>
                                <th scope="col" class="px-3 py-3 text-right text-xs font-medium uppercase tracking-wide text-gray-500 dark:text-gray-400">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="mappingsTableBody" class="divide-y divide-gray-100 dark:divide-gray-700">
                            {% for mapping in mappings %}
                            <tr id="mapping-row-{{ mapping.id }}" class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors mapping-row" data-mapping-id="{{ mapping.id }}" data-category="{{ mapping.category or '' }}" draggable="true">
                                <td class="whitespace-nowrap py-4 pl-2 pr-1">
                                    <div class="drag-handle cursor-grab active:cursor-grabbing text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                                        </svg>
                                    </div>
                                </td>
                                <td class="whitespace-nowrap py-4 pl-2 pr-3">
                                    <button
                                        data-toggle-mapping="{{ mapping.id }}"
                                        class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 {% if mapping.is_active %}bg-primary-600{% else %}bg-gray-200 dark:bg-gray-600{% endif %}"
                                        role="switch"
                                        aria-checked="{{ 'true' if mapping.is_active else 'false' }}"
                                        aria-label="Toggle mapping status"
                                    >
                                        <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out {% if mapping.is_active %}translate-x-5{% else %}translate-x-0{% endif %}"></span>
                                    </button>
                                </td>
                                <td class="whitespace-nowrap px-3 py-4">
                                    <div class="flex items-center gap-1.5 {% if not mapping.is_active %}opacity-50{% endif %}">
                                        {% if mapping.is_regex %}
                                        <span class="inline-flex items-center rounded px-1.5 py-0.5 text-xs font-medium bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300" title="Regular Expression">
                                            .*
                                        </span>
                                        {% endif %}
                                        <span class="inline-flex items-center rounded-md bg-gray-100 dark:bg-gray-700 px-2.5 py-1 text-sm font-mono text-gray-700 dark:text-gray-300">
                                            {{ mapping.pattern }}
                                        </span>
                                    </div>
                                </td>
                                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400 {% if not mapping.is_active %}opacity-50{% endif %}">
                                    {% if mapping.category %}
                                    <span class="inline-flex items-center rounded-full bg-blue-50 dark:bg-blue-900/30 px-2 py-0.5 text-xs font-medium text-blue-700 dark:text-blue-300">
                                        {{ mapping.category }}
                                    </span>
                                    {% else %}
                                    <span class="text-gray-300 dark:text-gray-600">—</span>
                                    {% endif %}
                                </td>
                                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">
                                    <span class="inline-flex items-center rounded-md bg-red-50 dark:bg-red-900/30 px-2.5 py-1 text-xs font-medium text-red-700 dark:text-red-400 {% if not mapping.is_active %}opacity-50{% endif %}">
                                        {{ mapping.from_account_name or mapping.from_account_id }}
                                    </span>
                                </td>
                                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500 dark:text-gray-400">
                                    <div class="flex items-center gap-2 {% if not mapping.is_active %}opacity-50{% endif %}">
                                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                                        </svg>
                                        <span class="inline-flex items-center rounded-md bg-green-50 dark:bg-green-900/30 px-2.5 py-1 text-xs font-medium text-green-700 dark:text-green-400">
                                            {{ mapping.to_account_name or mapping.to_account_id }}
                                        </span>
                                    </div>
                                </td>
                                <td class="whitespace-nowrap px-3 py-4 text-right text-sm">
                                    <div class="flex items-center justify-end gap-2">
                                        <a
                                            href="{{ url_for('journal.list_journals', account_id=mapping.from_account_id) }}"
                                            class="text-gray-400 hover:text-green-600 dark:hover:text-green-400 transition-colors"
                                            title="View journals for this account"
                                        >
                                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.64 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.64 0-8.573-3.007-9.963-7.178z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            </svg>
                                        </a>
                                        <button
                                            data-edit-mapping="true"
                                            data-mapping='{{ mapping | tojson }}'
                                            class="text-gray-400 hover:text-primary-600 dark:hover:text-primary-400 transition-colors"
                                            title="Edit mapping"
                                        >
                                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                                            </svg>
                                        </button>
                                        <button
                                            data-delete-mapping="{{ mapping.id }}"
                                            data-mapping-pattern="{{ mapping.pattern | e }}"
                                            class="text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition-colors"
                                            title="Delete mapping"
                                        >
                                            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                                            </svg>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <!-- Empty State -->
                <div id="emptyState" class="text-center py-12">
                    <svg class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                    </svg>
                    <h3 class="mt-4 text-sm font-semibold text-gray-900 dark:text-white">No mappings configured</h3>
                    <p class="mt-2 text-sm text-gray-500 dark:text-gray-400 max-w-sm mx-auto">
                        Create your first mapping to automatically remap journal entries.
                    </p>
                    <button
                        id="addFirstMappingBtn"
                        class="mt-4 inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-lg shadow-sm transition-colors"
                    >
                        <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                        </svg>
                        Add Your First Mapping
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Help Card -->
    <div class="bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800 rounded-xl overflow-hidden">
        <div class="p-4 sm:p-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-primary-600 dark:text-primary-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                    </svg>
                </div>
                <div class="ml-4">
                    <h3 class="text-sm font-semibold text-primary-900 dark:text-primary-300">How Mappings Work</h3>
                    <div class="mt-2 text-sm text-primary-700 dark:text-primary-400">
                        <ul class="list-disc pl-5 space-y-1">
                            <li><strong>Pattern:</strong> A text pattern to match in journal entry descriptions (case-insensitive)</li>
                            <li><strong>Regex:</strong> Enable regular expressions for advanced pattern matching (e.g., <code class="bg-primary-100 dark:bg-primary-800 px-1 rounded">INV-\d+</code> matches INV-001, INV-123)</li>
                            <li><strong>Category:</strong> Group related mappings together for better organization</li>
                            <li><strong>From Account:</strong> The account where matching entries are currently posted</li>
                            <li><strong>To Account:</strong> The account where entries should be moved to</li>
                            <li><strong>Toggle:</strong> Enable or disable a mapping without deleting it</li>
                            <li><strong>Reorder:</strong> Drag mappings using the handle (<svg class="inline h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>) to set priority — mappings are applied in order from top to bottom</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import/Export Modal -->
<div id="importExportModal" class="fixed inset-0 z-50 hidden" aria-labelledby="import-export-title" role="dialog" aria-modal="true">
    <div id="importExportBackdrop" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform rounded-2xl bg-white dark:bg-gray-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <!-- Modal Header -->
                <div class="px-6 pt-6 pb-4 border-b border-gray-100 dark:border-gray-700">
                    <div class="flex items-center gap-3">
                        <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 shadow-lg shadow-blue-500/30">
                            <svg class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 7.5h-.75A2.25 2.25 0 004.5 9.75v7.5a2.25 2.25 0 002.25 2.25h7.5a2.25 2.25 0 002.25-2.25v-7.5a2.25 2.25 0 00-2.25-2.25h-.75m0-3l-3-3m0 0l-3 3m3-3v11.25m6-2.25h.75a2.25 2.25 0 012.25 2.25v7.5a2.25 2.25 0 01-2.25 2.25h-7.5a2.25 2.25 0 01-2.25-2.25v-7.5a2.25 2.25 0 012.25-2.25h.75" />
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="import-export-title">Import / Export Mappings</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Transfer mappings as JSON</p>
                        </div>
                    </div>
                </div>

                <!-- Modal Body -->
                <div class="px-6 py-5 space-y-5">
                    <!-- Export Section -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-2 flex items-center gap-2">
                            <svg class="h-4 w-4 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                            </svg>
                            Export
                        </h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Download all mappings as a JSON file for backup or transfer.</p>
                        <button
                            type="button"
                            id="exportMappingsBtn"
                            class="w-full inline-flex items-center justify-center px-4 py-2.5 text-sm font-medium text-green-700 dark:text-green-300 bg-green-50 dark:bg-green-900/30 hover:bg-green-100 dark:hover:bg-green-900/50 border border-green-200 dark:border-green-700 rounded-lg transition-colors"
                        >
                            <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                            </svg>
                            Download JSON
                        </button>
                    </div>

                    <div class="border-t border-gray-200 dark:border-gray-700"></div>

                    <!-- Import Section -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-2 flex items-center gap-2">
                            <svg class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                            </svg>
                            Import
                        </h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Upload a JSON file to import mappings. Duplicates will be skipped.</p>
                        <div class="space-y-3">
                            <div class="flex items-center justify-center w-full">
                                <label for="importFile" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-700/50 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <svg class="w-8 h-8 mb-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" />
                                        </svg>
                                        <p class="mb-1 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                                        <p class="text-xs text-gray-400 dark:text-gray-500">JSON file only</p>
                                    </div>
                                    <input id="importFile" type="file" accept=".json,application/json" class="hidden" />
                                </label>
                            </div>
                            <div id="importFileInfo" class="hidden text-sm text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 rounded-lg px-3 py-2 flex items-center justify-between">
                                <span id="importFileName"></span>
                                <button type="button" id="clearImportFileBtn" class="text-gray-400 hover:text-red-500 transition-colors">
                                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <button
                                type="button"
                                id="importBtn"
                                disabled
                                class="w-full inline-flex items-center justify-center px-4 py-2.5 text-sm font-medium text-blue-700 dark:text-blue-300 bg-blue-50 dark:bg-blue-900/30 hover:bg-blue-100 dark:hover:bg-blue-900/50 border border-blue-200 dark:border-blue-700 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                                </svg>
                                Import Mappings
                            </button>
                        </div>
                    </div>

                    <!-- Import Results -->
                    <div id="importResults" class="hidden">
                        <div class="border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden">
                            <div class="px-3 py-2 bg-gray-50 dark:bg-gray-700 border-b border-gray-200 dark:border-gray-600">
                                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Import Results</span>
                            </div>
                            <div id="importResultsContent" class="px-3 py-3 text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700 rounded-b-2xl flex justify-end">
                    <button
                        type="button"
                        id="closeImportExportBtn"
                        class="px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 dark:focus:ring-offset-gray-800 transition-all"
                    >
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Mapping Modal -->
<div id="mappingModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div id="mappingModalBackdrop" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform rounded-2xl bg-white dark:bg-gray-800 text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-md">
                <form id="mappingForm" class="overflow-visible">
                    <input type="hidden" id="mappingId" name="id" value="">

                    <!-- Modal Header -->
                    <div class="px-6 pt-6 pb-4 border-b border-gray-100 dark:border-gray-700">
                        <div class="flex items-center gap-3">
                            <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-gradient-to-br from-primary-500 to-primary-600 shadow-lg shadow-primary-500/30">
                                <svg class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="modal-title">Add New Mapping</h3>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Define account reassignment rules</p>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Body -->
                    <div class="px-6 py-5 space-y-5 overflow-visible">
                        <!-- Pattern Input -->
                        <div>
                            <label for="pattern" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
                                Pattern <span class="text-red-500">*</span>
                            </label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                                        </svg>
                                    </div>
                                    <input
                                        type="text"
                                        id="pattern"
                                        name="pattern"
                                        required
                                        placeholder="e.g., Office Supplies"
                                        class="block w-full pl-9 pr-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow"
                                    >
                                </div>
                                <button
                                    type="button"
                                    id="testPatternBtn"
                                    class="inline-flex items-center px-3.5 py-2.5 text-sm font-medium text-primary-700 dark:text-primary-300 bg-primary-50 dark:bg-primary-900/50 hover:bg-primary-100 dark:hover:bg-primary-900/70 border border-primary-200 dark:border-primary-700 rounded-lg transition-all hover:shadow-sm whitespace-nowrap"
                                    title="Test pattern against recent journals"
                                >
                                    <svg class="h-4 w-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                    </svg>
                                    Test
                                </button>
                            </div>
                            <div class="mt-2 flex items-center justify-between">
                                <p id="patternHelp" class="text-xs text-gray-500 dark:text-gray-400">Text to match in journal descriptions (case-insensitive)</p>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="isRegex" name="is_regex" class="sr-only peer">
                                    <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-primary-300 dark:peer-focus:ring-primary-800 rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-500 peer-checked:bg-purple-600"></div>
                                    <span class="ms-2 text-xs font-medium text-gray-600 dark:text-gray-400">Regex</span>
                                </label>
                            </div>
                            <div id="regexError" class="hidden mt-1 text-xs text-red-600 dark:text-red-400"></div>
                        </div>

                        <!-- Category Input -->
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
                                Category <span class="text-gray-400 text-xs font-normal">(optional)</span>
                            </label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6z" />
                                    </svg>
                                </div>
                                <input
                                    type="text"
                                    id="category"
                                    name="category"
                                    list="categoryList"
                                    placeholder="e.g., Expenses, Revenue, Payroll"
                                    class="block w-full pl-9 pr-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow"
                                >
                                <datalist id="categoryList">
                                    <!-- Categories will be populated dynamically -->
                                </datalist>
                            </div>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Group mappings by category for organization</p>
                        </div>

                        <!-- Pattern Test Results -->
                        <div id="patternTestResults" class="hidden">
                            <div class="border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden bg-gray-50 dark:bg-gray-700/50">
                                <div class="px-3 py-2 border-b border-gray-200 dark:border-gray-600 flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                        <span id="testResultsTitle">Test Results</span>
                                    </span>
                                    <button
                                        type="button"
                                        id="hideTestResultsBtn"
                                        class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 p-0.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                                    >
                                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                <div id="testResultsContent" class="max-h-48 overflow-y-auto bg-white dark:bg-gray-800">
                                    <!-- Results will be inserted here -->
                                </div>
                            </div>
                        </div>

                        <!-- Account Mapping Section -->
                        <div class="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-4 space-y-4">
                            <div class="flex items-center gap-2 text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                                </svg>
                                Account Reassignment
                            </div>

                            <!-- From Account -->
                            <div>
                                <label for="fromAccountSearch" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
                                    From Account <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="inline-flex items-center justify-center h-5 w-5 rounded bg-red-100 dark:bg-red-900/50">
                                            <svg class="h-3 w-3 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" />
                                            </svg>
                                        </span>
                                    </div>
                                    <input
                                        type="text"
                                        id="fromAccountSearch"
                                        placeholder="Search accounts..."
                                        autocomplete="off"
                                        class="block w-full pl-11 pr-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow"
                                    >
                                    <input type="hidden" id="fromAccount" name="from_account_id" required>
                                    <div id="fromAccountDropdown" class="hidden absolute z-50 mt-1 w-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-xl max-h-60 overflow-auto">
                                        {% for account in accounts %}
                                        <div
                                            class="account-option px-3 py-2.5 cursor-pointer hover:bg-primary-50 dark:hover:bg-primary-900/50 text-sm text-gray-900 dark:text-gray-100 border-b border-gray-50 dark:border-gray-600 last:border-0"
                                            data-id="{{ account.id }}"
                                            data-name="{{ account.name }}"
                                            data-search="{{ account.name | lower }}"
                                        >
                                            {% if account.is_sub_account %}<span class="text-gray-300 dark:text-gray-500 mr-1">└</span>{% endif %}
                                            {{ account.name }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>

                            <!-- Arrow -->
                            <div class="flex justify-center">
                                <div class="flex items-center justify-center h-8 w-8 rounded-full bg-white dark:bg-gray-600 border-2 border-gray-200 dark:border-gray-500 shadow-sm">
                                    <svg class="h-4 w-4 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" />
                                    </svg>
                                </div>
                            </div>

                            <!-- To Account -->
                            <div>
                                <label for="toAccountSearch" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
                                    To Account <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <span class="inline-flex items-center justify-center h-5 w-5 rounded bg-green-100 dark:bg-green-900/50">
                                            <svg class="h-3 w-3 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 4.5l15 15m0 0V8.25m0 11.25H8.25" />
                                            </svg>
                                        </span>
                                    </div>
                                    <input
                                        type="text"
                                        id="toAccountSearch"
                                        placeholder="Search accounts..."
                                        autocomplete="off"
                                        class="block w-full pl-11 pr-3 py-2.5 border border-gray-300 dark:border-gray-600 rounded-lg text-sm placeholder-gray-400 dark:placeholder-gray-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-shadow"
                                    >
                                    <input type="hidden" id="toAccount" name="to_account_id" required>
                                    <div id="toAccountDropdown" class="hidden absolute z-50 mt-1 w-full bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-xl max-h-60 overflow-auto">
                                        {% for account in accounts %}
                                        <div
                                            class="account-option px-3 py-2.5 cursor-pointer hover:bg-primary-50 dark:hover:bg-primary-900/50 text-sm text-gray-900 dark:text-gray-100 border-b border-gray-50 dark:border-gray-600 last:border-0"
                                            data-id="{{ account.id }}"
                                            data-name="{{ account.name }}"
                                            data-search="{{ account.name | lower }}"
                                        >
                                            {% if account.is_sub_account %}<span class="text-gray-300 dark:text-gray-500 mr-1">└</span>{% endif %}
                                            {{ account.name }}
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Modal Footer -->
                    <div class="px-6 py-4 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700 rounded-b-2xl flex flex-col-reverse sm:flex-row sm:justify-end gap-2">
                        <button
                            type="button"
                            id="cancelMappingBtn"
                            class="w-full sm:w-auto px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 dark:focus:ring-offset-gray-800 transition-all"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            id="saveBtn"
                            class="w-full sm:w-auto px-5 py-2.5 text-sm font-medium text-white bg-gradient-to-r from-primary-600 to-primary-700 rounded-lg shadow-sm hover:from-primary-700 hover:to-primary-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-800 transition-all"
                        >
                            Save Mapping
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script nonce="{{ csp_nonce }}">
// Store accounts data for JavaScript
const accountsData = {{ accounts | tojson }};

// Searchable dropdown functionality
function initSearchableDropdown(searchId, hiddenId, dropdownId) {
    const searchInput = document.getElementById(searchId);
    const hiddenInput = document.getElementById(hiddenId);
    const dropdown = document.getElementById(dropdownId);
    const options = dropdown.querySelectorAll('.account-option');

    // Show dropdown on focus
    searchInput.addEventListener('focus', () => {
        dropdown.classList.remove('hidden');
        filterOptions('');
    });

    // Filter on input
    searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        filterOptions(query);
        // Clear hidden value when typing
        hiddenInput.value = '';
    });

    // Filter options
    function filterOptions(query) {
        let hasVisible = false;
        options.forEach(opt => {
            const searchText = opt.dataset.search;
            if (searchText.includes(query)) {
                opt.classList.remove('hidden');
                hasVisible = true;
            } else {
                opt.classList.add('hidden');
            }
        });
    }

    // Select option on click
    options.forEach(opt => {
        opt.addEventListener('click', () => {
            selectOption(opt);
        });
    });

    function selectOption(opt) {
        searchInput.value = opt.dataset.name;
        hiddenInput.value = opt.dataset.id;
        dropdown.classList.add('hidden');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    });

    // Keyboard navigation
    searchInput.addEventListener('keydown', (e) => {
        const visibleOptions = [...options].filter(opt => !opt.classList.contains('hidden'));
        const currentIndex = visibleOptions.findIndex(opt => opt.classList.contains('bg-primary-100'));

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            const nextIndex = currentIndex < visibleOptions.length - 1 ? currentIndex + 1 : 0;
            highlightOption(visibleOptions, nextIndex);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            const prevIndex = currentIndex > 0 ? currentIndex - 1 : visibleOptions.length - 1;
            highlightOption(visibleOptions, prevIndex);
        } else if (e.key === 'Enter') {
            e.preventDefault();
            const highlighted = visibleOptions.find(opt => opt.classList.contains('bg-primary-100'));
            if (highlighted) {
                selectOption(highlighted);
            }
        } else if (e.key === 'Escape') {
            dropdown.classList.add('hidden');
        }
    });

    function highlightOption(visibleOptions, index) {
        options.forEach(opt => opt.classList.remove('bg-primary-100'));
        if (visibleOptions[index]) {
            visibleOptions[index].classList.add('bg-primary-100');
            visibleOptions[index].scrollIntoView({ block: 'nearest' });
        }
    }

    // Return helper to set value programmatically
    return {
        setValue: (id, name) => {
            hiddenInput.value = id || '';
            searchInput.value = name || '';
        },
        clear: () => {
            hiddenInput.value = '';
            searchInput.value = '';
        }
    };
}

// Initialize dropdowns
let fromAccountDropdown, toAccountDropdown;
document.addEventListener('DOMContentLoaded', () => {
    fromAccountDropdown = initSearchableDropdown('fromAccountSearch', 'fromAccount', 'fromAccountDropdown');
    toAccountDropdown = initSearchableDropdown('toAccountSearch', 'toAccount', 'toAccountDropdown');

    // ========================================
    // Event Listeners (CSP-compliant)
    // ========================================

    // Add Mapping buttons
    const addMappingBtn = document.getElementById('addMappingBtn');
    if (addMappingBtn) addMappingBtn.addEventListener('click', openCreateModal);

    const addFirstMappingBtn = document.getElementById('addFirstMappingBtn');
    if (addFirstMappingBtn) addFirstMappingBtn.addEventListener('click', openCreateModal);

    // Import/Export Modal
    const openImportExportBtn = document.getElementById('openImportExportBtn');
    if (openImportExportBtn) openImportExportBtn.addEventListener('click', openImportExportModal);

    const importExportBackdrop = document.getElementById('importExportBackdrop');
    if (importExportBackdrop) importExportBackdrop.addEventListener('click', closeImportExportModal);

    const closeImportExportBtn = document.getElementById('closeImportExportBtn');
    if (closeImportExportBtn) closeImportExportBtn.addEventListener('click', closeImportExportModal);

    const exportMappingsBtn = document.getElementById('exportMappingsBtn');
    if (exportMappingsBtn) exportMappingsBtn.addEventListener('click', exportMappings);

    const importFile = document.getElementById('importFile');
    if (importFile) importFile.addEventListener('change', handleFileSelect);

    const clearImportFileBtn = document.getElementById('clearImportFileBtn');
    if (clearImportFileBtn) clearImportFileBtn.addEventListener('click', clearImportFile);

    const importBtn = document.getElementById('importBtn');
    if (importBtn) importBtn.addEventListener('click', importMappings);

    // Mapping Modal
    const mappingModalBackdrop = document.getElementById('mappingModalBackdrop');
    if (mappingModalBackdrop) mappingModalBackdrop.addEventListener('click', closeMappingModal);

    const cancelMappingBtn = document.getElementById('cancelMappingBtn');
    if (cancelMappingBtn) cancelMappingBtn.addEventListener('click', closeMappingModal);

    const mappingForm = document.getElementById('mappingForm');
    if (mappingForm) mappingForm.addEventListener('submit', saveMapping);

    const testPatternBtn = document.getElementById('testPatternBtn');
    if (testPatternBtn) testPatternBtn.addEventListener('click', testPattern);

    const hideTestResultsBtn = document.getElementById('hideTestResultsBtn');
    if (hideTestResultsBtn) hideTestResultsBtn.addEventListener('click', hideTestResults);

    const isRegexCheckbox = document.getElementById('isRegex');
    if (isRegexCheckbox) isRegexCheckbox.addEventListener('change', toggleRegexMode);

    // Category filter buttons
    document.querySelectorAll('.category-filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const category = btn.dataset.category;
            if (category === '') {
                filterByCategory(null);
            } else if (category === '__uncategorized__') {
                filterByCategory('__uncategorized__');
            } else {
                filterByCategory(category);
            }
        });
    });

    // Mapping row actions (use event delegation on the mapping table body)
    const mappingsTableBody = document.getElementById('mappingsTableBody');
    if (mappingsTableBody) {
        mappingsTableBody.addEventListener('click', (e) => {
            const toggleBtn = e.target.closest('[data-toggle-mapping]');
            if (toggleBtn) {
                e.preventDefault();
                toggleMapping(toggleBtn.dataset.toggleMapping);
                return;
            }

            const editBtn = e.target.closest('[data-edit-mapping]');
            if (editBtn) {
                e.preventDefault();
                openEditModal(editBtn);
                return;
            }

            const deleteBtn = e.target.closest('[data-delete-mapping]');
            if (deleteBtn) {
                e.preventDefault();
                confirmDeleteMapping(deleteBtn.dataset.deleteMapping, deleteBtn.dataset.mappingPattern);
                return;
            }
        });
    }
});

function openCreateModal() {
    document.getElementById('modal-title').textContent = 'Add New Mapping';
    document.getElementById('saveBtn').textContent = 'Save Mapping';
    document.getElementById('mappingForm').reset();
    document.getElementById('mappingId').value = '';
    document.getElementById('isRegex').checked = false;
    document.getElementById('category').value = '';
    if (fromAccountDropdown) fromAccountDropdown.clear();
    if (toAccountDropdown) toAccountDropdown.clear();
    hideTestResults();
    hideRegexError();
    updatePatternHelp(false);
    loadCategories();
    document.getElementById('mappingModal').classList.remove('hidden');
}

function openEditModal(button) {
    const mapping = JSON.parse(button.dataset.mapping);
    document.getElementById('modal-title').textContent = 'Edit Mapping';
    document.getElementById('saveBtn').textContent = 'Update Mapping';
    document.getElementById('mappingId').value = mapping.id;
    document.getElementById('pattern').value = mapping.pattern;
    document.getElementById('isRegex').checked = mapping.is_regex || false;
    document.getElementById('category').value = mapping.category || '';
    if (fromAccountDropdown) fromAccountDropdown.setValue(mapping.from_account_id, mapping.from_account_name);
    if (toAccountDropdown) toAccountDropdown.setValue(mapping.to_account_id, mapping.to_account_name);
    hideTestResults();
    hideRegexError();
    updatePatternHelp(mapping.is_regex || false);
    loadCategories();
    document.getElementById('mappingModal').classList.remove('hidden');
}

function closeMappingModal() {
    document.getElementById('mappingModal').classList.add('hidden');
    hideTestResults();
}

async function saveMapping(event) {
    event.preventDefault();

    const mappingId = document.getElementById('mappingId').value;
    const pattern = document.getElementById('pattern').value.trim();
    const isRegex = document.getElementById('isRegex').checked;
    const category = document.getElementById('category').value.trim();

    const fromAccountId = document.getElementById('fromAccount').value;
    const toAccountId = document.getElementById('toAccount').value;
    const fromAccountName = document.getElementById('fromAccountSearch').value;
    const toAccountName = document.getElementById('toAccountSearch').value;

    if (!pattern || !fromAccountId || !toAccountId) {
        window.showToast('Please fill in all required fields', 'error');
        return;
    }

    if (fromAccountId === toAccountId) {
        window.showToast('From and To accounts must be different', 'error');
        return;
    }

    // Validate regex if enabled
    if (isRegex) {
        const isValid = await validateRegexPattern(pattern);
        if (!isValid) {
            return;
        }
    }

    const data = {
        pattern: pattern,
        from_account_id: fromAccountId,
        from_account_name: fromAccountName,
        to_account_id: toAccountId,
        to_account_name: toAccountName,
        is_regex: isRegex,
        category: category || null
    };

    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.textContent;
    saveBtn.textContent = 'Saving...';
    saveBtn.disabled = true;

    try {
        let url = '/api/mappings';
        let method = 'POST';

        if (mappingId) {
            url = `/api/mappings/${mappingId}`;
            method = 'PUT';
        }

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            window.showToast(mappingId ? 'Mapping updated successfully' : 'Mapping created successfully', 'success');
            closeMappingModal();
            // Reload page to show updated mappings
            window.location.reload();
        } else {
            window.showToast(result.error || 'Failed to save mapping', 'error');
        }
    } catch (error) {
        console.error('Error saving mapping:', error);
        window.showToast('An error occurred while saving the mapping', 'error');
    } finally {
        saveBtn.textContent = originalText;
        saveBtn.disabled = false;
    }
}

async function toggleMapping(mappingId) {
    try {
        const response = await fetch(`/api/mappings/${mappingId}/toggle`, {
            method: 'POST'
        });

        const result = await response.json();

        if (response.ok) {
            const isActive = result.mapping.is_active;
            window.showToast(`Mapping ${isActive ? 'enabled' : 'disabled'}`, 'success');

            // Update UI without full page reload
            const row = document.getElementById(`mapping-row-${mappingId}`);
            const toggle = row.querySelector('button[role="switch"]');
            const toggleDot = toggle.querySelector('span');
            const elements = row.querySelectorAll('span:not([class*="translate"])');

            if (isActive) {
                toggle.classList.remove('bg-gray-200', 'dark:bg-gray-600');
                toggle.classList.add('bg-primary-600');
                toggleDot.classList.remove('translate-x-0');
                toggleDot.classList.add('translate-x-5');
                toggle.setAttribute('aria-checked', 'true');
                elements.forEach(el => el.classList.remove('opacity-50'));
            } else {
                toggle.classList.remove('bg-primary-600');
                toggle.classList.add('bg-gray-200', 'dark:bg-gray-600');
                toggleDot.classList.remove('translate-x-5');
                toggleDot.classList.add('translate-x-0');
                toggle.setAttribute('aria-checked', 'false');
                elements.forEach(el => {
                    if (!el.closest('button')) {
                        el.classList.add('opacity-50');
                    }
                });
            }
        } else {
            window.showToast(result.error || 'Failed to toggle mapping', 'error');
        }
    } catch (error) {
        console.error('Error toggling mapping:', error);
        window.showToast('An error occurred while toggling the mapping', 'error');
    }
}

async function confirmDeleteMapping(mappingId, pattern) {
    const confirmed = await window.showConfirm({
        title: 'Delete Mapping',
        message: `Are you sure you want to delete the mapping for pattern "${pattern}"? This action cannot be undone.`,
        confirmText: 'Delete',
        type: 'danger'
    });

    if (confirmed) {
        await deleteMapping(mappingId);
    }
}

async function deleteMapping(mappingId) {
    try {
        const response = await fetch(`/api/mappings/${mappingId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (response.ok) {
            window.showToast('Mapping deleted successfully', 'success');

            // Remove row from table
            const row = document.getElementById(`mapping-row-${mappingId}`);
            if (row) {
                row.remove();
            }

            // Update count
            const countEl = document.getElementById('mappingCount');
            const currentCount = parseInt(countEl.textContent);
            countEl.textContent = currentCount - 1;

            // Show empty state if no mappings left
            const tbody = document.getElementById('mappingsTableBody');
            if (tbody && tbody.children.length === 0) {
                window.location.reload();
            }
        } else {
            window.showToast(result.error || 'Failed to delete mapping', 'error');
        }
    } catch (error) {
        console.error('Error deleting mapping:', error);
        window.showToast('An error occurred while deleting the mapping', 'error');
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeMappingModal();
    }
});

// =============================================================================
// Pattern Testing
// =============================================================================

async function testPattern() {
    const pattern = document.getElementById('pattern').value.trim();
    const fromAccountId = document.getElementById('fromAccount').value;
    const isRegex = document.getElementById('isRegex').checked;

    if (!pattern) {
        window.showToast('Please enter a pattern to test', 'error');
        return;
    }

    if (!fromAccountId) {
        window.showToast('Please select a "From Account" first', 'error');
        return;
    }

    // Validate regex before testing
    if (isRegex) {
        const isValid = await validateRegexPattern(pattern);
        if (!isValid) {
            return;
        }
    }

    const testBtn = document.getElementById('testPatternBtn');
    const resultsContainer = document.getElementById('patternTestResults');
    const resultsContent = document.getElementById('testResultsContent');
    const resultsTitle = document.getElementById('testResultsTitle');

    // Show loading state
    testBtn.disabled = true;
    testBtn.innerHTML = `
        <svg class="animate-spin h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Testing...
    `;

    try {
        const response = await fetch('/api/mappings/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                pattern: pattern,
                from_account_id: fromAccountId,
                is_regex: isRegex
            })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            displayTestResults(result, pattern);
        } else {
            window.showToast(result.error || 'Failed to test pattern', 'error');
            hideTestResults();
        }
    } catch (error) {
        console.error('Error testing pattern:', error);
        window.showToast('An error occurred while testing the pattern', 'error');
        hideTestResults();
    } finally {
        // Reset button
        testBtn.disabled = false;
        testBtn.innerHTML = `
            <svg class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
            Test
        `;
    }
}

function displayTestResults(result, pattern) {
    const resultsContainer = document.getElementById('patternTestResults');
    const resultsContent = document.getElementById('testResultsContent');
    const resultsTitle = document.getElementById('testResultsTitle');

    // Update title with count
    const countText = result.truncated
        ? `${result.matches.length}+ matches (showing first 50)`
        : `${result.total_matches} match${result.total_matches !== 1 ? 'es' : ''}`;
    resultsTitle.textContent = countText;

    if (result.matches.length === 0) {
        resultsContent.innerHTML = `
            <div class="px-3 py-4 text-center text-sm text-gray-500 dark:text-gray-400">
                <svg class="mx-auto h-8 w-8 text-gray-300 dark:text-gray-600 mb-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                </svg>
                No matches found in the last 90 days.<br>
                <span class="text-xs">Try a different pattern or check the "From Account".</span>
            </div>
        `;
    } else {
        resultsContent.innerHTML = result.matches.map(match => {
            // Highlight the matched text
            const highlighted = highlightMatch(
                match.description,
                match.match_start,
                match.match_end
            );

            return `
                <div class="px-3 py-2 border-b border-gray-100 dark:border-gray-700 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700/50">
                    <div class="flex items-center justify-between gap-2">
                        <span class="text-xs text-gray-400 dark:text-gray-500 font-mono">#${match.journal_id}</span>
                        <span class="text-xs text-gray-400 dark:text-gray-500">${match.journal_date || ''}</span>
                    </div>
                    <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">${highlighted}</p>
                    <div class="flex items-center justify-between mt-1">
                        <span class="text-xs px-1.5 py-0.5 rounded ${match.posting_type === 'Debit' ? 'bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400' : 'bg-green-50 dark:bg-green-900/30 text-green-600 dark:text-green-400'}">
                            ${match.posting_type}
                        </span>
                        <span class="text-xs text-gray-500 dark:text-gray-400">$${formatAmount(match.amount)}</span>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Show results
    resultsContainer.classList.remove('hidden');
}

function highlightMatch(text, start, end) {
    if (start < 0 || end > text.length) return escapeHtml(text);

    const before = escapeHtml(text.substring(0, start));
    const match = escapeHtml(text.substring(start, end));
    const after = escapeHtml(text.substring(end));

    return `${before}<mark class="bg-yellow-200 dark:bg-yellow-500/30 text-yellow-900 dark:text-yellow-200 px-0.5 rounded">${match}</mark>${after}`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatAmount(amount) {
    if (amount == null) return '0.00';
    return parseFloat(amount).toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

function hideTestResults() {
    document.getElementById('patternTestResults').classList.add('hidden');
}

// =============================================================================
// Drag and Drop Reordering
// =============================================================================

let draggedRow = null;

function initDragAndDrop() {
    const tbody = document.getElementById('mappingsTableBody');
    if (!tbody) return;

    const rows = tbody.querySelectorAll('.mapping-row');

    rows.forEach(row => {
        // Drag start
        row.addEventListener('dragstart', (e) => {
            draggedRow = row;
            row.classList.add('opacity-50', 'bg-primary-50', 'dark:bg-primary-900/20');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', row.dataset.mappingId);
        });

        // Drag end
        row.addEventListener('dragend', () => {
            row.classList.remove('opacity-50', 'bg-primary-50', 'dark:bg-primary-900/20');
            draggedRow = null;

            // Remove all drop indicators
            rows.forEach(r => {
                r.classList.remove('border-t-2', 'border-b-2', 'border-primary-500');
            });
        });

        // Drag over
        row.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            if (draggedRow === row) return;

            // Show drop indicator
            const rect = row.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;

            rows.forEach(r => {
                r.classList.remove('border-t-2', 'border-b-2', 'border-primary-500');
            });

            if (e.clientY < midY) {
                row.classList.add('border-t-2', 'border-primary-500');
            } else {
                row.classList.add('border-b-2', 'border-primary-500');
            }
        });

        // Drag leave
        row.addEventListener('dragleave', () => {
            row.classList.remove('border-t-2', 'border-b-2', 'border-primary-500');
        });

        // Drop
        row.addEventListener('drop', async (e) => {
            e.preventDefault();

            if (draggedRow === row) return;

            // Remove drop indicators
            rows.forEach(r => {
                r.classList.remove('border-t-2', 'border-b-2', 'border-primary-500');
            });

            // Determine drop position
            const rect = row.getBoundingClientRect();
            const midY = rect.top + rect.height / 2;
            const insertBefore = e.clientY < midY;

            // Reorder in DOM
            if (insertBefore) {
                tbody.insertBefore(draggedRow, row);
            } else {
                tbody.insertBefore(draggedRow, row.nextSibling);
            }

            // Save new order to server
            await saveNewOrder();
        });
    });
}

async function saveNewOrder() {
    const tbody = document.getElementById('mappingsTableBody');
    const rows = tbody.querySelectorAll('.mapping-row');

    // Get new order of mapping IDs
    const order = Array.from(rows).map(row => parseInt(row.dataset.mappingId));

    try {
        const response = await fetch('/api/mappings/reorder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ order: order })
        });

        const result = await response.json();

        if (response.ok) {
            window.showToast('Mapping order saved', 'success');
        } else {
            window.showToast(result.error || 'Failed to save order', 'error');
        }
    } catch (error) {
        console.error('Error saving order:', error);
        window.showToast('Failed to save order', 'error');
    }
}

// Initialize drag and drop when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    initDragAndDrop();
});

// =============================================================================
// Category Filter
// =============================================================================

let currentCategoryFilter = null;

function filterByCategory(category) {
    currentCategoryFilter = category;
    const rows = document.querySelectorAll('.mapping-row');
    const buttons = document.querySelectorAll('.category-filter-btn');
    let visibleCount = 0;

    // Update button styles
    buttons.forEach(btn => {
        const btnCategory = btn.dataset.category;
        const isActive = (category === null && btnCategory === '') ||
                        (category === '__uncategorized__' && btnCategory === '__uncategorized__') ||
                        (category && btnCategory === category);

        btn.classList.remove('active', 'bg-primary-100', 'dark:bg-primary-900/50', 'text-primary-700', 'dark:text-primary-300',
                            'bg-blue-100', 'text-blue-700', 'dark:bg-blue-900/50', 'dark:text-blue-300',
                            'bg-gray-100', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-400');

        if (isActive) {
            btn.classList.add('active', 'bg-primary-100', 'dark:bg-primary-900/50', 'text-primary-700', 'dark:text-primary-300');
        } else {
            btn.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-600', 'dark:text-gray-400');
        }
    });

    // Filter rows
    rows.forEach(row => {
        const rowCategory = row.dataset.category || '';

        let show = false;
        if (category === null) {
            // Show all
            show = true;
        } else if (category === '__uncategorized__') {
            // Show only uncategorized (empty category)
            show = rowCategory === '';
        } else {
            // Show matching category
            show = rowCategory === category;
        }

        if (show) {
            row.classList.remove('hidden');
            visibleCount++;
        } else {
            row.classList.add('hidden');
        }
    });

    // Update visible count in header
    const countEl = document.getElementById('mappingCount');
    const totalCount = rows.length;
    if (category === null) {
        countEl.textContent = totalCount;
    } else {
        countEl.textContent = `${visibleCount} / ${totalCount}`;
    }

    // Show/hide empty state based on filter
    const emptyState = document.getElementById('emptyState');
    const table = document.querySelector('#mappingsContainer table');
    if (emptyState && table) {
        if (visibleCount === 0 && totalCount > 0) {
            // Hide table, show "no matches" message
            table.classList.add('hidden');
            if (!document.getElementById('noMatchesState')) {
                const noMatches = document.createElement('div');
                noMatches.id = 'noMatchesState';
                noMatches.className = 'text-center py-8 text-gray-500 dark:text-gray-400';
                noMatches.innerHTML = `
                    <svg class="mx-auto h-10 w-10 text-gray-300 dark:text-gray-600 mb-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c2.755 0 5.455.232 8.083.678.533.09.917.556.917 1.096v1.044a2.25 2.25 0 01-.659 1.591l-5.432 5.432a2.25 2.25 0 00-.659 1.591v2.927a2.25 2.25 0 01-1.244 2.013L9.75 21v-6.568a2.25 2.25 0 00-.659-1.591L3.659 7.409A2.25 2.25 0 013 5.818V4.774c0-.54.384-1.006.917-1.096A48.32 48.32 0 0112 3z" />
                    </svg>
                    <p>No mappings in this category</p>
                    <button id="showAllMappingsBtn" class="mt-2 text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400">Show all mappings</button>
                `;
                table.parentNode.appendChild(noMatches);
                document.getElementById('showAllMappingsBtn').addEventListener('click', () => filterByCategory(null));
            }
        } else {
            table.classList.remove('hidden');
            const noMatches = document.getElementById('noMatchesState');
            if (noMatches) noMatches.remove();
        }
    }
}

// =============================================================================
// Regex Helpers
// =============================================================================

function toggleRegexMode() {
    const isRegex = document.getElementById('isRegex').checked;
    updatePatternHelp(isRegex);
    hideRegexError();
}

function updatePatternHelp(isRegex) {
    const helpEl = document.getElementById('patternHelp');
    if (isRegex) {
        helpEl.textContent = 'Regular expression pattern (e.g., INV-\\d+ matches INV-001, INV-123)';
    } else {
        helpEl.textContent = 'Text to match in journal descriptions (case-insensitive)';
    }
}

async function validateRegexPattern(pattern) {
    try {
        const response = await fetch('/api/mappings/validate-regex', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pattern: pattern })
        });
        const result = await response.json();

        if (result.is_valid) {
            hideRegexError();
            return true;
        } else {
            showRegexError(result.error);
            return false;
        }
    } catch (error) {
        console.error('Error validating regex:', error);
        showRegexError('Failed to validate pattern');
        return false;
    }
}

function showRegexError(message) {
    const errorEl = document.getElementById('regexError');
    errorEl.textContent = 'Invalid regex: ' + message;
    errorEl.classList.remove('hidden');
}

function hideRegexError() {
    const errorEl = document.getElementById('regexError');
    errorEl.classList.add('hidden');
}

// =============================================================================
// Category Helpers
// =============================================================================

async function loadCategories() {
    try {
        const response = await fetch('/api/mappings/categories');
        const result = await response.json();

        if (result.success) {
            const datalist = document.getElementById('categoryList');
            datalist.innerHTML = '';

            result.categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                datalist.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// =============================================================================
// Import/Export
// =============================================================================

let importFileData = null;

function openImportExportModal() {
    document.getElementById('importExportModal').classList.remove('hidden');
    document.getElementById('importResults').classList.add('hidden');
    clearImportFile();
}

function closeImportExportModal() {
    document.getElementById('importExportModal').classList.add('hidden');
}

async function exportMappings() {
    try {
        const response = await fetch('/api/mappings/export');
        const data = await response.json();

        if (response.ok) {
            // Create and download file
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mappings-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            window.showToast(`Exported ${data.length} mappings`, 'success');
        } else {
            window.showToast(data.error || 'Export failed', 'error');
        }
    } catch (error) {
        console.error('Error exporting mappings:', error);
        window.showToast('Failed to export mappings', 'error');
    }
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            importFileData = JSON.parse(e.target.result);
            document.getElementById('importFileName').textContent = file.name;
            document.getElementById('importFileInfo').classList.remove('hidden');
            document.getElementById('importBtn').disabled = false;
        } catch (error) {
            window.showToast('Invalid JSON file', 'error');
            clearImportFile();
        }
    };
    reader.readAsText(file);
}

function clearImportFile() {
    importFileData = null;
    document.getElementById('importFile').value = '';
    document.getElementById('importFileInfo').classList.add('hidden');
    document.getElementById('importBtn').disabled = true;
}

async function importMappings() {
    if (!importFileData) {
        window.showToast('Please select a file first', 'error');
        return;
    }

    const importBtn = document.getElementById('importBtn');
    importBtn.disabled = true;
    importBtn.textContent = 'Importing...';

    try {
        const response = await fetch('/api/mappings/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(importFileData)
        });

        const result = await response.json();

        if (response.ok && result.success) {
            showImportResults(result);

            if (result.imported > 0) {
                window.showToast(`Imported ${result.imported} mappings`, 'success');
                // Reload after delay to show results
                setTimeout(() => window.location.reload(), 2000);
            } else {
                window.showToast('No new mappings to import', 'info');
            }
        } else {
            window.showToast(result.error || 'Import failed', 'error');
        }
    } catch (error) {
        console.error('Error importing mappings:', error);
        window.showToast('Failed to import mappings', 'error');
    } finally {
        importBtn.disabled = false;
        importBtn.innerHTML = `
            <svg class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
            </svg>
            Import Mappings
        `;
        clearImportFile();
    }
}

function showImportResults(result) {
    const resultsDiv = document.getElementById('importResults');
    const contentDiv = document.getElementById('importResultsContent');

    let html = `
        <div class="space-y-2">
            <div class="flex items-center justify-between">
                <span class="text-green-600 dark:text-green-400">Imported:</span>
                <span class="font-medium">${result.imported}</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-yellow-600 dark:text-yellow-400">Skipped:</span>
                <span class="font-medium">${result.skipped}</span>
            </div>
    `;

    if (result.errors && result.errors.length > 0) {
        html += `
            <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Errors:</p>
                <ul class="text-xs text-red-600 dark:text-red-400 space-y-0.5">
                    ${result.errors.map(e => `<li>${escapeHtml(e)}</li>`).join('')}
                </ul>
            </div>
        `;
    }

    html += '</div>';
    contentDiv.innerHTML = html;
    resultsDiv.classList.remove('hidden');
}

// Close import/export modal on Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeImportExportModal();
    }
});
</script>
{% endblock %}
